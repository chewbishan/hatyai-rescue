<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hatyai Flood Rescue Registry</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect } = React;

        function RescueFormApp() {
            const [entries, setEntries] = useState([]);
            const [searchTerm, setSearchTerm] = useState("");
            const [editingId, setEditingId] = useState(null);
            const [editForm, setEditForm] = useState({});
            const [form, setForm] = useState({
                hotel: "", 
                hotelAddress: "",
                room: "", 
                pax: "", 
                ages: "", 
                babyElderly: "", 
                phone: "", 
                supplies: "", 
                power: "", 
                medical: "", 
                evacuation: "", 
                nationality: "",
                remarks: ""
            });

            // Load saved data from localStorage
            useEffect(() => {
                const saved = localStorage.getItem('rescueEntries');
                if (saved) {
                    setEntries(JSON.parse(saved));
                }
            }, []);

            // Save to localStorage whenever entries change
            useEffect(() => {
                localStorage.setItem('rescueEntries', JSON.stringify(entries));
            }, [entries]);

            const handleChange = (e) => {
                setForm({ ...form, [e.target.name]: e.target.value });
            };

            const handleSearchChange = (e) => {
                setSearchTerm(e.target.value);
            };

            const checkForDuplicate = () => {
                if (!form.hotel && !form.room && !form.phone) return false;
                
                return entries.some(entry => 
                    (form.hotel && entry.hotel?.toLowerCase().includes(form.hotel.toLowerCase())) ||
                    (form.room && entry.room?.toLowerCase().includes(form.room.toLowerCase())) ||
                    (form.phone && entry.phone?.includes(form.phone))
                );
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                
                // Check for potential duplicates
                const isDuplicate = checkForDuplicate();
                if (isDuplicate && !window.confirm("This entry seems similar to an existing one. Are you sure you want to submit?")) {
                    return;
                }

                const newEntry = { 
                    ...form, 
                    id: Date.now(), 
                    timestamp: new Date().toLocaleString(),
                    rescued: false, // New field to track rescue status
                    rescueTimestamp: "" // When they were rescued
                };
                setEntries([...entries, newEntry]);
                setForm({
                    hotel: "", 
                    hotelAddress: "", 
                    room: "", 
                    pax: "", 
                    ages: "", 
                    babyElderly: "", 
                    phone: "", 
                    supplies: "", 
                    power: "", 
                    medical: "", 
                    evacuation: "", 
                    nationality: "",
                    remarks: ""
                });
                setSearchTerm(""); // Clear search after submission
                alert("Registration submitted successfully!");
            };

            // DELETE FUNCTION
            const handleDelete = (id) => {
                if (window.confirm("Are you sure you want to delete this entry?")) {
                    const updatedEntries = entries.filter(entry => entry.id !== id);
                    setEntries(updatedEntries);
                    alert("Entry deleted successfully!");
                }
            };

            // RESCUE STATUS TOGGLE
            const handleRescueToggle = (id) => {
                const updatedEntries = entries.map(entry => {
                    if (entry.id === id) {
                        return {
                            ...entry,
                            rescued: !entry.rescued,
                            rescueTimestamp: !entry.rescued ? new Date().toLocaleString() : ""
                        };
                    }
                    return entry;
                });
                setEntries(updatedEntries);
            };

            // EDIT FUNCTIONS
            const handleEdit = (entry) => {
                setEditingId(entry.id);
                setEditForm({ ...entry });
            };

            const handleEditChange = (e) => {
                setEditForm({ ...editForm, [e.target.name]: e.target.value });
            };

            const handleSaveEdit = () => {
                const updatedEntries = entries.map(entry => 
                    entry.id === editingId 
                        ? { ...editForm, timestamp: new Date().toLocaleString() }
                        : entry
                );
                setEntries(updatedEntries);
                setEditingId(null);
                setEditForm({});
                alert("Entry updated successfully!");
            };

            const handleCancelEdit = () => {
                setEditingId(null);
                setEditForm({});
            };

            const exportToGoogleSheets = () => {
                if (entries.length === 0) {
                    alert("No data to export");
                    return;
                }

                const headers = [
                    "Timestamp", "Hotel", "Hotel Address", "Room", "Pax", "Ages", 
                    "Baby/Elderly", "Phone", "Supplies", "Power", "Medical", 
                    "Evacuation", "Nationality", "Remarks", "Rescued", "Rescue Timestamp"
                ];
                
                const csvContent = [
                    headers.join(","),
                    ...entries.map(entry => [
                        `"${entry.timestamp}"`,
                        `"${entry.hotel}"`,
                        `"${entry.hotelAddress}"`,
                        `"${entry.room}"`,
                        `"${entry.pax}"`,
                        `"${entry.ages}"`,
                        `"${entry.babyElderly}"`,
                        `"${entry.phone}"`,
                        `"${entry.supplies}"`,
                        `"${entry.power}"`,
                        `"${entry.medical}"`,
                        `"${entry.evacuation}"`,
                        `"${entry.nationality}"`,
                        `"${entry.remarks}"`,
                        `"${entry.rescued ? 'YES' : 'NO'}"`,
                        `"${entry.rescueTimestamp || ''}"`
                    ].join(","))
                ].join("\n");

                const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", "hatyai_rescue_data.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            const generateQRCode = () => {
                const currentUrl = window.location.href;
                const qrCodeUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(currentUrl)}`;
                
                return (
                    React.createElement('div', { className: 'mt-4 p-4 border rounded-lg bg-white' },
                        React.createElement('h3', { className: 'text-lg font-semibold mb-2' }, 'Share this App'),
                        React.createElement('p', { className: 'text-sm text-gray-600 mb-2' }, 'Scan this QR code to access the rescue registry:'),
                        React.createElement('img', { 
                            src: qrCodeUrl, 
                            alt: 'QR Code', 
                            className: 'mx-auto border rounded' 
                        }),
                        React.createElement('p', { className: 'text-xs text-gray-500 mt-2 text-center' },
                            'Or share this link: ',
                            React.createElement('br'),
                            React.createElement('span', { className: 'break-all' }, currentUrl)
                        )
                    )
                );
            };

            // Filter entries based on search term
            const filteredEntries = entries.filter(entry => 
                entry.hotel?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                entry.room?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                entry.phone?.includes(searchTerm) ||
                entry.nationality?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                entry.hotelAddress?.toLowerCase().includes(searchTerm.toLowerCase())
            );

            return (
                React.createElement('div', { className: 'p-6 max-w-4xl mx-auto' },
                    // Title
                    React.createElement('h1', { className: 'text-3xl font-bold mb-4' }, 'Hatyai Flood Rescue Registry'),
                    
                    // Buttons
                    React.createElement('div', { className: 'flex gap-3 mb-6 flex-wrap' },
                        React.createElement('button', {
                            onClick: exportToGoogleSheets,
                            className: 'bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded flex items-center gap-2'
                        }, 'ðŸ“¥ Export to Google Sheets'),
                        React.createElement('button', {
                            onClick: () => {
                                navigator.clipboard.writeText(window.location.href);
                                alert('App link copied to clipboard!');
                            },
                            className: 'bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded flex items-center gap-2'
                        }, 'ðŸ”— Copy App Link')
                    ),
                    
                    // QR Code
                    generateQRCode(),

                    // Search Box
                    React.createElement('div', { className: 'mb-6 mt-6' },
                        React.createElement('h2', { className: 'text-xl font-semibold mb-3' }, 'Check Existing Registrations'),
                        React.createElement('p', { className: 'text-sm text-gray-600 mb-2' }, 
                            'Search by hotel, room number, phone, or nationality to check if you are already registered:'
                        ),
                        React.createElement('input', {
                            type: 'text',
                            placeholder: 'Search by hotel, room, phone, or nationality...',
                            value: searchTerm,
                            onChange: handleSearchChange,
                            className: 'w-full p-3 border rounded-lg shadow-sm'
                        })
                    ),

                    // Quick summary of search results
                    searchTerm && React.createElement('div', { className: 'mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg' },
                        React.createElement('p', { className: 'text-sm' },
                            React.createElement('strong', null, `Found ${filteredEntries.length} matching registration(s)`),
                            ' - Please check if you are already in the list below before submitting a new registration.'
                        )
                    ),

                    // Form
                    React.createElement('form', { onSubmit: handleSubmit, className: 'grid grid-cols-1 md:grid-cols-2 gap-3 mb-8 mt-6' },
                        // Form inputs - Row 1
                        React.createElement('input', { 
                            className: 'p-2 border rounded', 
                            placeholder: 'Hotel Name', 
                            name: 'hotel', 
                            value: form.hotel, 
                            onChange: handleChange
                        }),
                        React.createElement('input', { 
                            className: 'p-2 border rounded', 
                            placeholder: 'Hotel Address', 
                            name: 'hotelAddress', 
                            value: form.hotelAddress, 
                            onChange: handleChange 
                        }),
                        
                        // Row 2
                        React.createElement('input', { 
                            className: 'p-2 border rounded', 
                            placeholder: 'Room Number', 
                            name: 'room', 
                            value: form.room, 
                            onChange: handleChange
                        }),
                        React.createElement('input', { 
                            className: 'p-2 border rounded', 
                            placeholder: 'Number of Pax', 
                            name: 'pax', 
                            value: form.pax, 
                            onChange: handleChange
                        }),
                        
                        // Row 3
                        React.createElement('input', { 
                            className: 'p-2 border rounded', 
                            placeholder: 'Ages (e.g., 35,42,8)', 
                            name: 'ages', 
                            value: form.ages, 
                            onChange: handleChange 
                        }),
                        React.createElement('input', { 
                            className: 'p-2 border rounded', 
                            placeholder: 'Baby/Elderly (yes/no)', 
                            name: 'babyElderly', 
                            value: form.babyElderly, 
                            onChange: handleChange 
                        }),
                        
                        // Row 4
                        React.createElement('input', { 
                            className: 'p-2 border rounded', 
                            placeholder: 'Phone Number', 
                            name: 'phone', 
                            value: form.phone, 
                            onChange: handleChange
                        }),
                        React.createElement('input', { 
                            className: 'p-2 border rounded', 
                            placeholder: 'Water/Food Left (days)', 
                            name: 'supplies', 
                            value: form.supplies, 
                            onChange: handleChange 
                        }),
                        
                        // Row 5
                        React.createElement('input', { 
                            className: 'p-2 border rounded', 
                            placeholder: 'Power Status', 
                            name: 'power', 
                            value: form.power, 
                            onChange: handleChange 
                        }),
                        React.createElement('input', { 
                            className: 'p-2 border rounded', 
                            placeholder: 'Medical Needs', 
                            name: 'medical', 
                            value: form.medical, 
                            onChange: handleChange 
                        }),
                        
                        // Row 6
                        React.createElement('input', { 
                            className: 'p-2 border rounded', 
                            placeholder: 'Evacuation Needed (yes/no)', 
                            name: 'evacuation', 
                            value: form.evacuation, 
                            onChange: handleChange 
                        }),
                        React.createElement('input', { 
                            className: 'p-2 border rounded', 
                            placeholder: 'Nationality', 
                            name: 'nationality', 
                            value: form.nationality, 
                            onChange: handleChange
                        }),
                        
                        // Remarks (full width)
                        React.createElement('textarea', { 
                            className: 'md:col-span-2 p-2 border rounded', 
                            placeholder: 'Remarks / Additional Information (e.g., special needs, exact location details, etc.)', 
                            name: 'remarks', 
                            value: form.remarks, 
                            onChange: handleChange,
                            rows: 3 
                        }),
                        
                        // Submit button
                        React.createElement('div', { className: 'md:col-span-2' },
                            React.createElement('button', { 
                                className: 'bg-blue-600 hover:bg-blue-700 text-white p-2 rounded w-full' 
                            }, 'Submit Registration')
                        )
                    ),

                    // Summary
                    entries.length > 0 && React.createElement('div', { className: 'mb-6 p-4 bg-blue-50 rounded-lg' },
                        React.createElement('h3', { className: 'font-semibold mb-2' }, 'Summary:'),
                        React.createElement('p', null, 'Total Registrations: ', React.createElement('strong', null, entries.length)),
                        React.createElement('p', null, 'Need Evacuation: ', React.createElement('strong', null, entries.filter(e => e.evacuation?.toLowerCase() === 'yes').length)),
                        React.createElement('p', null, 'With Medical Needs: ', React.createElement('strong', null, entries.filter(e => e.medical && e.medical !== '').length)),
                        React.createElement('p', null, 'Rescued: ', 
                            React.createElement('strong', { className: 'text-green-600' }, entries.filter(e => e.rescued).length),
                            ' / ',
                            React.createElement('strong', { className: 'text-red-600' }, entries.filter(e => !e.rescued).length),
                            ' still waiting'
                        )
                    ),

                    // Entries list
                    React.createElement('h2', { className: 'text-2xl font-semibold mb-2' }, 
                        `Registered Individuals/Families (${searchTerm ? filteredEntries.length + ' of ' + entries.length : entries.length})`
                    ),
                    
                    // Search info
                    searchTerm && filteredEntries.length === 0 && 
                        React.createElement('p', { className: 'text-green-600 bg-green-50 p-3 rounded mb-4' },
                            'No existing registrations found with your search. You can proceed to submit a new registration.'
                        ),

                    entries.length === 0 
                        ? React.createElement('p', { className: 'text-gray-500 text-center py-4' }, 'No registrations yet. Please fill out the form above.')
                        : React.createElement('div', { className: 'grid gap-3' }, 
                            (searchTerm ? filteredEntries : entries).map((e) => 
                                React.createElement('div', { 
                                    key: e.id, 
                                    className: `border p-3 rounded shadow ${e.rescued ? 'bg-green-50 border-green-200' : 'bg-white'}`
                                },
                                    // Rescue Status Badge
                                    React.createElement('div', { className: 'flex justify-between items-center mb-2' },
                                        React.createElement('span', { 
                                            className: `px-3 py-1 rounded-full text-sm font-bold ${e.rescued ? 'bg-green-500 text-white' : 'bg-red-500 text-white'}`
                                        }, e.rescued ? 'âœ… RESCUED' : 'ðŸ†˜ NEEDS RESCUE'),
                                        React.createElement('div', { className: 'flex gap-2' },
                                            // Rescue Toggle Button
                                            React.createElement('button', {
                                                onClick: () => handleRescueToggle(e.id),
                                                className: `px-3 py-1 rounded text-sm ${e.rescued ? 'bg-yellow-500 hover:bg-yellow-600' : 'bg-green-500 hover:bg-green-600'} text-white`
                                            }, e.rescued ? 'Mark as Not Rescued' : 'Mark as Rescued'),
                                            // Edit Button
                                            React.createElement('button', {
                                                onClick: () => handleEdit(e),
                                                className: 'px-3 py-1 rounded text-sm bg-blue-500 hover:bg-blue-600 text-white'
                                            }, 'Edit'),
                                            // Delete Button
                                            React.createElement('button', {
                                                onClick: () => handleDelete(e.id),
                                                className: 'px-3 py-1 rounded text-sm bg-red-500 hover:bg-red-600 text-white'
                                            }, 'Delete')
                                        )
                                    ),

                                    // Rescue timestamp
                                    e.rescued && e.rescueTimestamp && 
                                        React.createElement('p', { className: 'text-sm text-green-600 mb-2' }, 
                                            `Rescued on: ${e.rescueTimestamp}`
                                        ),

                                    editingId === e.id ? (
                                        // EDIT MODE
                                        React.createElement('div', { className: 'grid grid-cols-1 md:grid-cols-2 gap-2' },
                                            React.createElement('input', { 
                                                className: 'p-1 border rounded text-sm', 
                                                placeholder: 'Hotel Name', 
                                                name: 'hotel', 
                                                value: editForm.hotel, 
                                                onChange: handleEditChange
                                            }),
                                            React.createElement('input', { 
                                                className: 'p-1 border rounded text-sm', 
                                                placeholder: 'Hotel Address', 
                                                name: 'hotelAddress', 
                                                value: editForm.hotelAddress, 
                                                onChange: handleEditChange 
                                            }),
                                            React.createElement('input', { 
                                                className: 'p-1 border rounded text-sm', 
                                                placeholder: 'Room Number', 
                                                name: 'room', 
                                                value: editForm.room, 
                                                onChange: handleEditChange
                                            }),
                                            React.createElement('input', { 
                                                className: 'p-1 border rounded text-sm', 
                                                placeholder: 'Number of Pax', 
                                                name: 'pax', 
                                                value: editForm.pax, 
                                                onChange: handleEditChange
                                            }),
                                            React.createElement('input', { 
                                                className: 'p-1 border rounded text-sm', 
                                                placeholder: 'Phone Number', 
                                                name: 'phone', 
                                                value: editForm.phone, 
                                                onChange: handleEditChange
                                            }),
                                            React.createElement('input', { 
                                                className: 'p-1 border rounded text-sm', 
                                                placeholder: 'Nationality', 
                                                name: 'nationality', 
                                                value: editForm.nationality, 
                                                onChange: handleEditChange
                                            }),
                                            React.createElement('textarea', { 
                                                className: 'md:col-span-2 p-1 border rounded text-sm', 
                                                placeholder: 'Remarks', 
                                                name: 'remarks', 
                                                value: editForm.remarks, 
                                                onChange: handleEditChange,
                                                rows: 2 
                                            }),
                                            React.createElement('div', { className: 'md:col-span-2 flex gap-2' },
                                                React.createElement('button', {
                                                    onClick: handleSaveEdit,
                                                    className: 'bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm'
                                                }, 'Save'),
                                                React.createElement('button', {
                                                    onClick: handleCancelEdit,
                                                    className: 'bg-gray-500 hover:bg-gray-600 text-white px-3 py-1 rounded text-sm'
                                                }, 'Cancel')
                                            )
                                        )
                                    ) : (
                                        // VIEW MODE
                                        React.createElement('div', { className: 'grid grid-cols-1 md:grid-cols-2 gap-2' },
                                            React.createElement('p', null, React.createElement('strong', null, 'Hotel:'), ' ', e.hotel || 'Not provided'),
                                            React.createElement('p', null, React.createElement('strong', null, 'Address:'), ' ', e.hotelAddress || 'Not provided'),
                                            React.createElement('p', null, React.createElement('strong', null, 'Room:'), ' ', e.room || 'Not provided'),
                                            React.createElement('p', null, React.createElement('strong', null, 'Pax:'), ' ', e.pax || 'Not provided'),
                                            React.createElement('p', null, React.createElement('strong', null, 'Ages:'), ' ', e.ages || 'Not provided'),
                                            React.createElement('p', null, React.createElement('strong', null, 'Baby/Elderly:'), ' ', e.babyElderly || 'Not provided'),
                                            React.createElement('p', null, React.createElement('strong', null, 'Phone:'), ' ', e.phone || 'Not provided'),
                                            React.createElement('p', null, React.createElement('strong', null, 'Supplies:'), ' ', e.supplies || 'Not provided'),
                                            React.createElement('p', null, React.createElement('strong', null, 'Power:'), ' ', e.power || 'Not provided'),
                                            React.createElement('p', null, React.createElement('strong', null, 'Medical:'), ' ', e.medical || 'None'),
                                            React.createElement('p', null, React.createElement('strong', null, 'Evacuation:'), ' ', 
                                                React.createElement('span', { className: e.evacuation?.toLowerCase() === 'yes' ? 'text-red-600 font-bold' : 'text-green-600' }, e.evacuation || 'Not specified')),
                                            React.createElement('p', null, React.createElement('strong', null, 'Nationality:'), ' ', e.nationality || 'Not provided'),
                                            e.remarks && React.createElement('p', { className: 'md:col-span-2' }, 
                                                React.createElement('strong', null, 'Remarks:'), ' ', e.remarks)
                                        )
                                    ),
                                    React.createElement('p', { className: 'text-xs text-gray-500 mt-2' }, `Registered: ${e.timestamp}`)
                                )
                            )
                          )
                )
            );
        }

        ReactDOM.render(React.createElement(RescueFormApp), document.getElementById('root'));
    </script>
</body>
</html>
