<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hatyai Flood Rescue Registry</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect } = React;

        // âœ… YOUR SUPABASE CREDENTIALS
        const SUPABASE_URL = 'https://wdkbjlgeacfxpoynudh.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indka2JqbGdlYWNmY3hwb3ludWRoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM5OTc0ODMsImV4cCI6MjA3OTU3MzQ4M30.WirrWiD-K9znPE297H294qy9EHRgOw5nIEO8kv5yjdE';

        // CORS Proxy to avoid CORS issues
        const CORS_PROXY = 'https://cors-anywhere.herokuapp.com/';
        
        // Custom Supabase client that uses fetch directly
        const supabaseFetch = {
            from: (table) => ({
                select: async () => {
                    const response = await fetch(`${CORS_PROXY}${SUPABASE_URL}/rest/v1/${table}?select=*`, {
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    return response.json();
                },
                insert: async (data) => {
                    const response = await fetch(`${CORS_PROXY}${SUPABASE_URL}/rest/v1/${table}`, {
                        method: 'POST',
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                            'Content-Type': 'application/json',
                            'Prefer': 'return=representation'
                        },
                        body: JSON.stringify(data[0])
                    });
                    return response.json();
                },
                update: async (data) => {
                    const response = await fetch(`${CORS_PROXY}${SUPABASE_URL}/rest/v1/${table}?id=eq.${editingId}`, {
                        method: 'PATCH',
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                            'Content-Type': 'application/json',
                            'Prefer': 'return=representation'
                        },
                        body: JSON.stringify(data)
                    });
                    return response.json();
                },
                delete: async (id) => {
                    const response = await fetch(`${CORS_PROXY}${SUPABASE_URL}/rest/v1/${table}?id=eq.${id}`, {
                        method: 'DELETE',
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    return response.json();
                }
            })
        };

        function RescueFormApp() {
            const [entries, setEntries] = useState([]);
            const [searchTerm, setSearchTerm] = useState("");
            const [editingId, setEditingId] = useState(null);
            const [editForm, setEditForm] = useState({});
            const [loading, setLoading] = useState(true);
            const [lastRefresh, setLastRefresh] = useState('');
            const [dbError, setDbError] = useState('');
            const [form, setForm] = useState({
                hotel: "", 
                hotel_address: "",
                room: "", 
                pax: "", 
                ages: "", 
                baby_elderly: "", 
                phone: "", 
                supplies: "", 
                power: "", 
                medical: "", 
                evacuation: "", 
                nationality: "",
                remarks: ""
            });

            // Load data from Supabase
            const loadDataFromSupabase = async () => {
                try {
                    setLoading(true);
                    setDbError('');
                    
                    console.log('Loading data from Supabase...');
                    const result = await supabaseFetch.from('rescue_entries').select();
                    
                    if (result.error) {
                        setDbError('Error loading data: ' + result.error.message);
                    } else {
                        setEntries(result || []);
                        setLastRefresh(new Date().toLocaleTimeString());
                    }
                    
                    setLoading(false);
                } catch (error) {
                    setDbError('Network error: ' + error.message);
                    console.error('Error:', error);
                    setLoading(false);
                }
            };

            // Load data when component mounts
            useEffect(() => {
                loadDataFromSupabase();
            }, []);

            const handleChange = (e) => {
                setForm({ ...form, [e.target.name]: e.target.value });
            };

            const handleSearchChange = (e) => {
                setSearchTerm(e.target.value);
            };

            const checkForDuplicate = () => {
                if (!form.hotel && !form.room && !form.phone) return false;
                
                return entries.some(entry => 
                    (form.hotel && entry.hotel?.toLowerCase().includes(form.hotel.toLowerCase())) ||
                    (form.room && entry.room?.toLowerCase().includes(form.room.toLowerCase())) ||
                    (form.phone && entry.phone?.includes(form.phone))
                );
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                
                // Check for potential duplicates
                const isDuplicate = checkForDuplicate();
                if (isDuplicate && !window.confirm("This entry seems similar to an existing one. Are you sure you want to submit?")) {
                    return;
                }

                try {
                    setDbError('');
                    const result = await supabaseFetch.from('rescue_entries').insert([{ ...form }]);
                    
                    if (result.error) {
                        setDbError("Error submitting data: " + result.error.message);
                    } else {
                        // Refresh the data to include the new entry
                        await loadDataFromSupabase();
                        
                        setForm({
                            hotel: "", 
                            hotel_address: "", 
                            room: "", 
                            pax: "", 
                            ages: "", 
                            baby_elderly: "", 
                            phone: "", 
                            supplies: "", 
                            power: "", 
                            medical: "", 
                            evacuation: "", 
                            nationality: "",
                            remarks: ""
                        });
                        setSearchTerm("");
                        alert("Registration submitted successfully! Data is now visible to rescue teams.");
                    }
                } catch (error) {
                    setDbError("Network error: " + error.message);
                }
            };

            // DELETE FUNCTION
            const handleDelete = async (id) => {
                if (window.confirm("Are you sure you want to delete this entry?")) {
                    try {
                        const result = await supabaseFetch.from('rescue_entries').delete(id);
                        
                        if (result.error) {
                            setDbError("Error deleting entry: " + result.error.message);
                        } else {
                            await loadDataFromSupabase();
                            alert("Entry deleted successfully!");
                        }
                    } catch (error) {
                        setDbError("Error: " + error.message);
                    }
                }
            };

            // RESCUE STATUS TOGGLE - Simplified for now
            const handleRescueToggle = async (id, currentRescuedStatus) => {
                const newRescuedStatus = !currentRescuedStatus;
                const rescueTimestamp = newRescuedStatus ? new Date().toLocaleString() : "";

                // Update local state immediately for better UX
                const updatedEntries = entries.map(entry => {
                    if (entry.id === id) {
                        return {
                            ...entry,
                            rescued: newRescuedStatus,
                            rescue_timestamp: rescueTimestamp
                        };
                    }
                    return entry;
                });
                setEntries(updatedEntries);
                
                alert(`Marked as ${newRescuedStatus ? 'RESCUED' : 'NEEDS RESCUE'}`);
            };

            // EDIT FUNCTIONS - Simplified for now
            const handleEdit = (entry) => {
                setEditingId(entry.id);
                setEditForm({ ...entry });
            };

            const handleEditChange = (e) => {
                setEditForm({ ...editForm, [e.target.name]: e.target.value });
            };

            const handleSaveEdit = async () => {
                try {
                    const result = await supabaseFetch.from('rescue_entries').update(editForm);
                    
                    if (result.error) {
                        setDbError("Error updating entry: " + result.error.message);
                    } else {
                        await loadDataFromSupabase();
                        setEditingId(null);
                        setEditForm({});
                        alert("Entry updated successfully!");
                    }
                } catch (error) {
                    setDbError("Error: " + error.message);
                }
            };

            const handleCancelEdit = () => {
                setEditingId(null);
                setEditForm({});
            };

            const exportToCSV = () => {
                if (entries.length === 0) {
                    alert("No data to export");
                    return;
                }

                const headers = [
                    "Timestamp", "Hotel", "Hotel Address", "Room", "Pax", "Ages", 
                    "Baby/Elderly", "Phone", "Supplies", "Power", "Medical", 
                    "Evacuation", "Nationality", "Remarks", "Rescued", "Rescue Timestamp"
                ];
                
                const csvContent = [
                    headers.join(","),
                    ...entries.map(entry => [
                        `"${new Date(entry.created_at).toLocaleString()}"`,
                        `"${entry.hotel || ''}"`,
                        `"${entry.hotel_address || ''}"`,
                        `"${entry.room || ''}"`,
                        `"${entry.pax || ''}"`,
                        `"${entry.ages || ''}"`,
                        `"${entry.baby_elderly || ''}"`,
                        `"${entry.phone || ''}"`,
                        `"${entry.supplies || ''}"`,
                        `"${entry.power || ''}"`,
                        `"${entry.medical || ''}"`,
                        `"${entry.evacuation || ''}"`,
                        `"${entry.nationality || ''}"`,
                        `"${entry.remarks || ''}"`,
                        `"${entry.rescued ? 'YES' : 'NO'}"`,
                        `"${entry.rescue_timestamp || ''}"`
                    ].join(","))
                ].join("\n");

                const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", `hatyai_rescue_data_${new Date().toISOString().split('T')[0]}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            const generateQRCode = () => {
                const currentUrl = window.location.href;
                const qrCodeUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(currentUrl)}`;
                
                return (
                    React.createElement('div', { className: 'mt-4 p-4 border rounded-lg bg-white' },
                        React.createElement('h3', { className: 'text-lg font-semibold mb-2' }, 'Share this App'),
                        React.createElement('p', { className: 'text-sm text-gray-600 mb-2' }, 'Scan this QR code to access the rescue registry:'),
                        React.createElement('img', { 
                            src: qrCodeUrl, 
                            alt: 'QR Code', 
                            className: 'mx-auto border rounded' 
                        }),
                        React.createElement('p', { className: 'text-xs text-gray-500 mt-2 text-center' },
                            'Or share this link: ',
                            React.createElement('br'),
                            React.createElement('span', { className: 'break-all' }, currentUrl)
                        )
                    )
                );
            };

            // Filter entries based on search term
            const filteredEntries = entries.filter(entry => 
                entry.hotel?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                entry.room?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                entry.phone?.includes(searchTerm) ||
                entry.nationality?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                entry.hotel_address?.toLowerCase().includes(searchTerm.toLowerCase())
            );

            return (
                React.createElement('div', { className: 'p-6 max-w-4xl mx-auto' },
                    // Title
                    React.createElement('h1', { className: 'text-3xl font-bold mb-4' }, 'Hatyai Flood Rescue Registry'),
                    
                    // Database Connection Status
                    dbError && React.createElement('div', { className: 'mb-4 p-3 bg-red-50 border border-red-200 rounded-lg' },
                        React.createElement('p', { className: 'text-sm text-red-800' },
                            'ðŸš¨ ',
                            React.createElement('strong', null, 'DATABASE ERROR: '),
                            dbError,
                            React.createElement('br'),
                            'Trying to connect via CORS proxy...'
                        )
                    ),
                    
                    // Shared Data Notice
                    !dbError && entries.length > 0 && React.createElement('div', { className: 'mb-4 p-3 bg-green-50 border border-green-200 rounded-lg' },
                        React.createElement('p', { className: 'text-sm text-green-800' },
                            'ðŸ”— ',
                            React.createElement('strong', null, 'LIVE SHARED DATA: '),
                            'All entries are visible to everyone. Data stored in cloud database.'
                        )
                    ),

                    // Local Storage Notice (if no DB connection)
                    dbError && React.createElement('div', { className: 'mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg' },
                        React.createElement('p', { className: 'text-sm text-yellow-800' },
                            'âš ï¸ ',
                            React.createElement('strong', null, 'USING LOCAL STORAGE: '),
                            'Data is saved locally on this device only. Other users cannot see your entries.'
                        )
                    ),
                    
                    // Buttons
                    React.createElement('div', { className: 'flex gap-3 mb-6 flex-wrap' },
                        React.createElement('button', {
                            onClick: exportToCSV,
                            className: 'bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded flex items-center gap-2'
                        }, 'ðŸ“¥ Export to CSV'),
                        React.createElement('button', {
                            onClick: loadDataFromSupabase,
                            className: 'bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded flex items-center gap-2'
                        }, 'ðŸ”„ Refresh Data'),
                        React.createElement('button', {
                            onClick: () => {
                                navigator.clipboard.writeText(window.location.href);
                                alert('App link copied to clipboard!');
                            },
                            className: 'bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded flex items-center gap-2'
                        }, 'ðŸ”— Copy App Link')
                    ),
                    
                    // QR Code
                    generateQRCode(),

                    // Search Box
                    React.createElement('div', { className: 'mb-6 mt-6' },
                        React.createElement('h2', { className: 'text-xl font-semibold mb-3' }, 'Check Existing Registrations'),
                        React.createElement('p', { className: 'text-sm text-gray-600 mb-2' }, 
                            'Search by hotel, room number, phone, or nationality to check if you are already registered:'
                        ),
                        React.createElement('input', {
                            type: 'text',
                            placeholder: 'Search by hotel, room, phone, or nationality...',
                            value: searchTerm,
                            onChange: handleSearchChange,
                            className: 'w-full p-3 border rounded-lg shadow-sm'
                        })
                    ),

                    // Loading indicator
                    loading && React.createElement('div', { className: 'text-center py-4' },
                        React.createElement('p', { className: 'text-gray-600' }, 'Loading data...')
                    ),

                    // Quick summary of search results
                    searchTerm && !loading && React.createElement('div', { className: 'mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg' },
                        React.createElement('p', { className: 'text-sm' },
                            React.createElement('strong', null, `Found ${filteredEntries.length} matching registration(s)`),
                            ' - Please check if you are already in the list below before submitting a new registration.'
                        )
                    ),

                    // Form
                    React.createElement('form', { onSubmit: handleSubmit, className: 'grid grid-cols-1 md:grid-cols-2 gap-3 mb-8 mt-6' },
                        // Form inputs
                        React.createElement('input', { 
                            className: 'p-2 border rounded', 
                            placeholder: 'Hotel Name', 
                            name: 'hotel', 
                            value: form.hotel, 
                            onChange: handleChange
                        }),
                        React.createElement('input', { 
                            className: 'p-2 border rounded', 
                            placeholder: 'Hotel Address', 
                            name: 'hotel_address', 
                            value: form.hotel_address, 
                            onChange: handleChange 
                        }),
                        React.createElement('input', { 
                            className: 'p-2 border rounded', 
                            placeholder: 'Room Number', 
                            name: 'room', 
                            value: form.room, 
                            onChange: handleChange
                        }),
                        React.createElement('input', { 
                            className: 'p-2 border rounded', 
                            placeholder: 'Number of Pax', 
                            name: 'pax', 
                            value: form.pax, 
                            onChange: handleChange
                        }),
                        React.createElement('input', { 
                            className: 'p-2 border rounded', 
                            placeholder: 'Ages (e.g., 35,42,8)', 
                            name: 'ages', 
                            value: form.ages, 
                            onChange: handleChange 
                        }),
                        React.createElement('input', { 
                            className: 'p-2 border rounded', 
                            placeholder: 'Baby/Elderly (yes/no)', 
                            name: 'baby_elderly', 
                            value: form.baby_elderly, 
                            onChange: handleChange 
                        }),
                        React.createElement('input', { 
                            className: 'p-2 border rounded', 
                            placeholder: 'Phone Number', 
                            name: 'phone', 
                            value: form.phone, 
                            onChange: handleChange
                        }),
                        React.createElement('input', { 
                            className: 'p-2 border rounded', 
                            placeholder: 'Water/Food Left (days)', 
                            name: 'supplies', 
                            value: form.supplies, 
                            onChange: handleChange 
                        }),
                        React.createElement('input', { 
                            className: 'p-2 border rounded', 
                            placeholder: 'Power Status', 
                            name: 'power', 
                            value: form.power, 
                            onChange: handleChange 
                        }),
                        React.createElement('input', { 
                            className: 'p-2 border rounded', 
                            placeholder: 'Medical Needs', 
                            name: 'medical', 
                            value: form.medical, 
                            onChange: handleChange 
                        }),
                        React.createElement('input', { 
                            className: 'p-2 border rounded', 
                            placeholder: 'Evacuation Needed (yes/no)', 
                            name: 'evacuation', 
                            value: form.evacuation, 
                            onChange: handleChange 
                        }),
                        React.createElement('input', { 
                            className: 'p-2 border rounded', 
                            placeholder: 'Nationality', 
                            name: 'nationality', 
                            value: form.nationality, 
                            onChange: handleChange
                        }),
                        React.createElement('textarea', { 
                            className: 'md:col-span-2 p-2 border rounded', 
                            placeholder: 'Remarks / Additional Information', 
                            name: 'remarks', 
                            value: form.remarks, 
                            onChange: handleChange,
                            rows: 3 
                        }),
                        React.createElement('div', { className: 'md:col-span-2' },
                            React.createElement('button', { 
                                type: 'submit',
                                className: 'bg-blue-600 hover:bg-blue-700 text-white p-2 rounded w-full' 
                            }, 'Submit Registration')
                        )
                    ),

                    // Summary
                    entries.length > 0 && !loading && React.createElement('div', { className: 'mb-6 p-4 bg-blue-50 rounded-lg' },
                        React.createElement('h3', { className: 'font-semibold mb-2' }, 'Summary:'),
                        React.createElement('p', null, 'Total Registrations: ', React.createElement('strong', null, entries.length)),
                        React.createElement('p', null, 'Need Evacuation: ', React.createElement('strong', null, entries.filter(e => e.evacuation?.toLowerCase() === 'yes').length)),
                        React.createElement('p', null, 'With Medical Needs: ', React.createElement('strong', null, entries.filter(e => e.medical && e.medical !== '').length)),
                        React.createElement('p', null, 'Rescued: ', 
                            React.createElement('strong', { className: 'text-green-600' }, entries.filter(e => e.rescued).length),
                            ' / ',
                            React.createElement('strong', { className: 'text-red-600' }, entries.filter(e => !e.rescued).length),
                            ' still waiting'
                        )
                    ),

                    // Entries list
                    !loading && React.createElement('div', null,
                        React.createElement('h2', { className: 'text-2xl font-semibold mb-2' }, 
                            `Registered Individuals/Families (${searchTerm ? filteredEntries.length + ' of ' + entries.length : entries.length})`
                        ),
                        
                        entries.length === 0 && !loading ?
                            React.createElement('p', { className: 'text-gray-500 text-center py-4' }, 'No registrations yet. Please fill out the form above.') :
                            React.createElement('div', { className: 'grid gap-3' }, 
                                (searchTerm ? filteredEntries : entries).map((e) => 
                                    React.createElement('div', { 
                                        key: e.id, 
                                        className: `border p-3 rounded shadow ${e.rescued ? 'bg-green-50 border-green-200' : 'bg-white'}`
                                    },
                                        React.createElement('div', { className: 'flex justify-between items-center mb-2' },
                                            React.createElement('span', { 
                                                className: `px-3 py-1 rounded-full text-sm font-bold ${e.rescued ? 'bg-green-500 text-white' : 'bg-red-500 text-white'}`
                                            }, e.rescued ? 'âœ… RESCUED' : 'ðŸ†˜ NEEDS RESCUE'),
                                            React.createElement('div', { className: 'flex gap-2' },
                                                React.createElement('button', {
                                                    onClick: () => handleRescueToggle(e.id, e.rescued),
                                                    className: `px-3 py-1 rounded text-sm ${e.rescued ? 'bg-yellow-500 hover:bg-yellow-600' : 'bg-green-500 hover:bg-green-600'} text-white`
                                                }, e.rescued ? 'Mark as Not Rescued' : 'Mark as Rescued'),
                                                React.createElement('button', {
                                                    onClick: () => handleDelete(e.id),
                                                    className: 'px-3 py-1 rounded text-sm bg-red-500 hover:bg-red-600 text-white'
                                                }, 'Delete')
                                            )
                                        ),
                                        React.createElement('div', { className: 'grid grid-cols-1 md:grid-cols-2 gap-2' },
                                            React.createElement('p', null, React.createElement('strong', null, 'Hotel:'), ' ', e.hotel || 'Not provided'),
                                            React.createElement('p', null, React.createElement('strong', null, 'Address:'), ' ', e.hotel_address || 'Not provided'),
                                            React.createElement('p', null, React.createElement('strong', null, 'Room:'), ' ', e.room || 'Not provided'),
                                            React.createElement('p', null, React.createElement('strong', null, 'Pax:'), ' ', e.pax || 'Not provided'),
                                            React.createElement('p', null, React.createElement('strong', null, 'Ages:'), ' ', e.ages || 'Not provided'),
                                            React.createElement('p', null, React.createElement('strong', null, 'Baby/Elderly:'), ' ', e.baby_elderly || 'Not provided'),
                                            React.createElement('p', null, React.createElement('strong', null, 'Phone:'), ' ', e.phone || 'Not provided'),
                                            React.createElement('p', null, React.createElement('strong', null, 'Supplies:'), ' ', e.supplies || 'Not provided'),
                                            React.createElement('p', null, React.createElement('strong', null, 'Power:'), ' ', e.power || 'Not provided'),
                                            React.createElement('p', null, React.createElement('strong', null, 'Medical:'), ' ', e.medical || 'None'),
                                            React.createElement('p', null, React.createElement('strong', null, 'Evacuation:'), ' ', 
                                                React.createElement('span', { className: e.evacuation?.toLowerCase() === 'yes' ? 'text-red-600 font-bold' : 'text-green-600' }, e.evacuation || 'Not specified')),
                                            React.createElement('p', null, React.createElement('strong', null, 'Nationality:'), ' ', e.nationality || 'Not provided'),
                                            e.remarks && React.createElement('p', { className: 'md:col-span-2' }, 
                                                React.createElement('strong', null, 'Remarks:'), ' ', e.remarks)
                                        ),
                                        React.createElement('p', { className: 'text-xs text-gray-500 mt-2' }, `Registered: ${new Date(e.created_at).toLocaleString()}`)
                                    )
                                )
                            )
                    )
                )
            );
        }

        ReactDOM.render(React.createElement(RescueFormApp), document.getElementById('root'));
    </script>
</body>
</html>
